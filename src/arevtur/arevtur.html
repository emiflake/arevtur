<style>
	@import '../themeStyle.css';
	@import '../sharedStyle.css';

	body {
		display: flex
	}

	.container {
		display: flex;
		flex-direction: column;
		flex: 1
	}

	x-results {
		margin-top: 15px;
		flex: 1;
		flex-basis: 0;
	}
</style>

<script>
	require('./xElements/import');
</script>

<div class="container">
	<x-inputs></x-inputs>
	<x-results></x-results>
</div>

<script>
	const {TradeQueryParams} = require('./TradeQuery');
	const $ = document.querySelector.bind(document);

	let lastTradeQueryParams;
	let submitQueries = async tradeQueryParams => {
		cancelQueries();
		lastTradeQueryParams = tradeQueryParams;
		let progressRatios = tradeQueryParams.map(_ => 0);
		tradeQueryParams.forEach((queryParam, i) =>
			queryParam.getItemsStream((text, ratio) => {
				console.log('progress', text, ratio);
				progressRatios[i] = ratio;
				let avgProgressRatio = progressRatios.reduce((sum, v) => sum + v) /
					progressRatios.length;
				$('x-results').updateItemsProgress(avgProgressRatio);
			}, $('x-inputs').pobApi).forEach(items => {
				$('x-results').joinItems(items);
				$('x-results').renderItemsData();
			}));
	};

	let cancelQueries = () => {
		lastTradeQueryParams?.forEach(queryParam => queryParam.stop());
		lastTradeQueryParams = null;
	};

	$('x-inputs').addEventListener('submit', async e => {
		if (!e.detail.add)
			$('x-results').clearItems();
		submitQueries(await $('x-inputs').getTradeQueryParams());
	});

	$('x-inputs').addEventListener('cancel', cancelQueries);

	$('x-results').addEventListener('submit', async e =>
		submitQueries(await $('x-inputs').getTradeQueryParams(e.detail.overridePrice)));

	// todo
	// assume quality 0%
	// items sometimes coming back without pseudo mod 'Sum: '
</script>
